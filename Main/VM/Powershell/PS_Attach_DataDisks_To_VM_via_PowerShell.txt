--Attaching Data Disks to VM in Azure Tenant via PowerShell 

--Project Details
--Cloud Connect Consult (3C) Project
--Prepared by GS
--Email 			  : CloudConnectConsult@Outlook.com   
--Start Date		  : 11/11/2021 07:50 AM 	(MM/DD/YYYY HH:MM AM/PM)
--Date Completion	  : 11/11/2021  AM	(MM/DD/YYYY HH:MM AM/PM)


--It is recommended to store Apps and Data on Data Disks and Leave OS Disk for OS
--Each Data disk has Maximum Size of 4 TB
--Generally Speaking you can attach, maximum 64 Data disks to VM (Depending on VM Size)

Process or creating and Attaching Data disk has primarily 4 steps 


Step 1: Data Disk Configuration

Type the following Command and Hit Enter 

$diskconfig = New-AzDiskConfig `
            -Location "EastUS" `
            -CreateOption Empty `
            -DiskSizeGB 128 

--Non eventful, no message came

Step 2: Data Disk Resource Creation

$datadisk = New-AzDisk  `
            -ResourceGroupName "VmLabMS" `
            -DiskName "DataDisk" `
            -Disk $diskconfig 


--Non eventful, no message came

--Check the status of Data Disk created by last Command

Get-AzDisk -ResourceGroupName "VmLabMS" -DiskName  "DataDisk"


ResourceGroupName            : VmLabMS
ManagedBy                    :
ManagedByExtended            : {}
Sku                          : Microsoft.Azure.Management.Compute.Models.DiskSku
Zones                        :
TimeCreated                  : 11-11-2021 02:50:30
OsType                       :
HyperVGeneration             :
CreationData                 : Microsoft.Azure.Management.Compute.Models.CreationData
DiskSizeGB                   : 128
DiskSizeBytes                : 137438953472
UniqueId                     : d527bfa6-ec95-4678-8b97-5d3957fbb756
EncryptionSettingsCollection :
ProvisioningState            : Succeeded
DiskIOPSReadWrite            : 500
DiskMBpsReadWrite            : 60
DiskIOPSReadOnly             :
DiskMBpsReadOnly             :
DiskState                    : Unattached
Encryption                   : Microsoft.Azure.Management.Compute.Models.Encryption
MaxShares                    :
ShareInfo                    : {}
Id                           : /subscriptions/15252525-949e-4f6f-a344-gfdgdgdgd152/resourceGroups/VmLabMS/providers/Microsoft
                               .Compute/disks/DataDisk
Name                         : DataDisk
Type                         : Microsoft.Compute/disks
Location                     : eastus
ExtendedLocation             :
Tags                         : {}
NetworkAccessPolicy          : AllowAll
DiskAccessId                 :
Tier                         :
BurstingEnabled              :
PurchasePlan                 :
SupportsHibernation          :
SecurityProfile              :


Step 3: Add Data Disk to VM 

--Get the VM details, where we need to attach the datadisk
--Loand VM details in a variable, type following hit enter

$vm = Get-AZVM -ResourceGroupName "VmLabMS" -Name "myVMms"

--Usually uneventful, no messge returned, now that we have the Vm configuration in $Vm
-- Lets add the Disk details into same varaible.. Type following and hit enter

 $vm = Add-AzVmDataDisk `
    -VM  $vm `
    -Name "DataDisk" `
    -CreateOption Attach `
    -ManagedDiskId $datadisk.Id `
    -Lun 1

--Usually uneventful, no messge returned,

--As a next step update vm with latest VM configuration, so taht Disk is visible to OS

Update-AzVM -ResourceGroupName "VmLabMS" -VM $vm

--Following Response received on PowerShell prompt

RequestId IsSuccessStatusCode StatusCode ReasonPhrase
--------- ------------------- ---------- ------------
                         True         OK OK


Step 4: Update VM Configuration

--Once the disk is attached to vm, disk must be Configured with Operating system.
--Disk must be initialized and partition must be created.
--those partition must be formated similar to any physical disk. 

--Get the IP address for the vm to connet 

Get-AzPublicIpAddress -ResourceGroupName "VmLabms" | Select "IpAddress"

IpAddress
---------
20.115.10.145

to mstsc into vm, use the following command  "mstsc /v:publicIpAddress"

Type Following command and Hit Enter, it will prompt you to put credentials , use the credentials you have set initially
and login

	mstsc /v:20.115.10.145

--Once connected, Open an powershell session in admin mode and write the following command
--This command would be using a lot of piping, what piping does is , it takes output from one command 
-- and supply it into other command 

--Type the following command and hit enter

Get-Disk | Where partitionstyle -eq 'raw'| `
Initialize-Disk -PartitionStyle MBR -PassThru | `
New-Partition -AssignDriveLetter -UseMaximumSize | `
Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisk" -Confirm:$false

--Following output on powershell internal vm prompt

PS C:\Users\gpsadmin> Get-Disk | Where partitionstyle -eq 'raw'| `
>> Initialize-Disk -PartitionStyle MBR -PassThru | `
>> New-Partition -AssignDriveLetter -UseMaximumSize | `
>> Format-Volume -FileSystem NTFS -NewFileSystemLabel "DataDisk" -Confirm:$false

DriveLetter FileSystemLabel FileSystem DriveType HealthStatus OperationalStatus SizeRemaining   Size
----------- --------------- ---------- --------- ------------ ----------------- -------------   ----
F           DataDisk        NTFS       Fixed     Healthy      OK                    127.89 GB 128 GB


**Running the command will still give you prompt to Format the new disk, since you already formated, 
**you can simply close it .

--Command Bifurcation
--Get-Disk : Retrives disk that are visible to Operating system
--Partition Style: Brand new Disk has partition style raw

It will get the any raw disk attached to VM/OS

--Initialize-Disk : Initialzes a Raw Disk for the first time use
--on initialization we are giving it a switch -MBR, (Master Boot Record)
--Passthru, allows us to pass the output of this command to other

--New-Partition: command Creates a new Partition on an existing Disk
--AssignDriveLetter as not assinged would be Default
--UseMaximumSize, will use maixmum size of disk

--Format-Volume: Formats a new or exisitng volumne on Disk
--FileSystem will be NTFS
--NewFileSystemLabel, will name the data disk name



@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@


-- Once done with Practice, you can delete all by simply removing the resource group, all associated with resource group will be deleted.

Remove-AzResourceGroup -Name VMLABMS 

when prompted, type Y and hit enter.





~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~End Of File~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Let's Make World a better place to work !