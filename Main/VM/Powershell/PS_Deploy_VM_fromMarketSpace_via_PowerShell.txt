--Deploying VM to Azure Tenant from Marketspace via PowerShell 

--Project Details
--Cloud Connect Consult (3C) Project
--Prepared by GS
--Email 			    : CloudConnectConsult@Outlook.com  
--Start Date		    : 11/10/2021 04:21 AM 	(MM/DD/YYYY HH:MM AM/PM)
--Date Completion	    : 11/10/2021 05:10 AM	(MM/DD/YYYY HH:MM AM/PM)


-- Azure Markeplace offers numerus different images  
-- Deploying an VM image from Markeplace require few addional steps 
   comparing to Default OS provisioning.
-- Identify a Publisher
    Get-AzVmImagePublisher
-- Identify an offers
    Get-AzVmImageOffer
-- Locating an SKU
    Get-AzVmImageSKU

Step#1
-- Type the following command and Hit Enter

Import-Module -Name Az

--Usually UnEventfull, no message will come

--Connect Azure Tenant
-- Connect-AzAccount is the easiest way to connect to Azure from Powershell
--Type the following command and hit enter

Connect-AzAccount

--It will open dialog box for credentials, as soon as you enter, will print tenant details
--and control comes back to command prompt 

Account                     SubscriptionName TenantId                             Environment
-------                     ---------------- --------                             -----------
gurp1234569@hotmail.com 	Pay-As-You-Go    466a9e44-466a9e44-466a9e44-466a9e44 AzureCloud


--Create a Resource Group under which VM will be Deployed, 
--The Azure Resource Group is a logical Container that is used for Grouping Azure Resources

--Type the following command and Hit Enter

New-AzResourceGroup -ResourceGroupName "VmlabMS" -Location "EastUS"

--Prints the following

ResourceGroupName : VmLabMS
Location          : eastus
ProvisioningState : Succeeded
Tags              :
ResourceId        : /subscriptions/xxxxxx-yyyyy-4f6f-a344-xxxxxxxxx/resourceGroups/VmLab

--you can validate on Azure Portal, also get the list of all resource groups

--Type the following command Hit Enter, it will list out all the resource groups in connected Tenant

Get-AzResourceGroup


-- Deploying a VM from Marketspae image,

--Process of provisioning a VM from Marketspace require following steps, 

 1. "Get-Credential" is used to capture credentials, allows to specify administrative credentials for the vm, so when the vm is provisioned , it will have 
 a local admin on that. Type following and hit enter
 
   \> $cred = Get-Credential
   
   it will prompt login credentials, it will store credentials in $cred
 
 cmdlet Get-Credential at command pipeline position 1
	Supply values for the following parameters:
	Credential

  >it will open Login popup, where you can set credentials in this case I have set gpsadmin/Welcome#2024
  credentials are stored in $cred variable 
   
 2. type the following command and Hit Enter, it will give you list of Image publisher in 
  mentioned location
 
  Get-AzVmImagePublisher -Location "EastUS"

 3. type the following command and Hit Enter, it will give you list of offers Image publisher has in 
  mentioned location
 
 Get-AzVmImageOffer -Location "EastUS" -PublisherName "MicrosoftWindowsServer"

It returns following List on 11/10/2021 MM-DD-YYYY

Offer                                     PublisherName          Location Id
-----                                     -------------          -------- --
19h1gen2servertest                        MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
microsoftserveroperatingsystems-previews  MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
servertesting                             MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-1607-vhd-server-prod-stage     MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-1607-vhd-sf-server-prod-stage  MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-1803-vhd-server-prod-stage     MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-1809-vhd-server-prod-stage     MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-1809-vhd-sf-server-prod-stage  MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-1903-vhd-server-prod-stage     MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-1909-vhd-server-prod-stage     MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-2004-vhd-server-prod-stage     MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-10-20h2-vhd-server-prod-stage     MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-7-0-sp1-vhd-server-prod-stage     MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-8-0-vhd-server-prod-stage         MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-8-1-vhd-server-prod-stage         MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-cvm                               MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windows-server-2012-vhd-server-prod-stage MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
WindowsServer                             MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windowsserver-gen2preview                 MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windowsserver-previewtest                 MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
windowsserverdotnet                       MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
WindowsServerSemiAnnual                   MicrosoftWindowsServer eastus   MicrosoftWindowsServer eastus   /Subscriptions/asdsadsadsa12324365459ce-121-4f6f...
 


4. type the following command and Hit Enter, it will give you list of SKU publisher has to offer in particular Image at 
  mentioned location
 
 Get-AzVmImageSKU -Location "EastUS" -PublisherName "MicrosoftWindowsServer" -Offer "WindowsServer"

It returns following List on 11/10/2021 MM-DD-YYYY

Skus                                              Offer         PublisherName          Location Id
----                                              -----         -------------          -------- --
2008-R2-SP1                                       WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2008-R2-SP1-smalldisk                             WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2008-R2-SP1-zhcn                                  WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-Datacenter                                   WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-datacenter-gensecond                         WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-Datacenter-smalldisk                         WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-datacenter-smalldisk-g2                      WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-Datacenter-zhcn                              WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-datacenter-zhcn-g2                           WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-R2-Datacenter                                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-r2-datacenter-gensecond                      WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-R2-Datacenter-smalldisk                      WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-r2-datacenter-smalldisk-g2                   WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-R2-Datacenter-zhcn                           WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2012-r2-datacenter-zhcn-g2                        WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-Datacenter                                   WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-datacenter-gensecond                         WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-datacenter-gs                                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-Datacenter-Server-Core                       WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-datacenter-server-core-g2                    WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-Datacenter-Server-Core-smalldisk             WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-datacenter-server-core-smalldisk-g2          WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-Datacenter-smalldisk                         WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-datacenter-smalldisk-g2                      WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-Datacenter-with-Containers                   WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-datacenter-with-containers-g2                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-datacenter-with-containers-gs                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-Datacenter-zhcn                              WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2016-datacenter-zhcn-g2                           WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter                                   WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter-Core                              WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-core-g2                           WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter-Core-smalldisk                    WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-core-smalldisk-g2                 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter-Core-with-Containers              WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-core-with-containers-g2           WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter-Core-with-Containers-smalldisk    WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-core-with-containers-smalldisk-g2 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-gensecond                         WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-gs                                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter-smalldisk                         WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-smalldisk-g2                      WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter-with-Containers                   WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-with-containers-g2                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-with-containers-gs                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter-with-Containers-smalldisk         WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-with-containers-smalldisk-g2      WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-Datacenter-zhcn                              WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2019-datacenter-zhcn-g2                           WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter                                   WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-azure-edition                     WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-azure-edition-core                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-azure-edition-core-smalldisk      WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-azure-edition-smalldisk           WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-core                              WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-core-g2                           WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-core-smalldisk                    WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-core-smalldisk-g2                 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-g2                                WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-smalldisk                         WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
2022-datacenter-smalldisk-g2                      WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-1803-with-containers-smalldisk-g2 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-1809-with-containers-smalldisk-g2 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
Datacenter-Core-1903-with-Containers-smalldisk    WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-1903-with-containers-smalldisk-g2 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-1909-with-containers-smalldisk    WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-1909-with-containers-smalldisk-g1 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-1909-with-containers-smalldisk-g2 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-2004-with-containers-smalldisk    WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-2004-with-containers-smalldisk-g2 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-20h2-with-containers-smalldisk    WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-20h2-with-containers-smalldisk-g2 WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...
datacenter-core-20h2-with-containers-smalldisk-gs WindowsServer MicrosoftWindowsServer eastus   /Subscriptions/1cf519ce-94...


5. I have decided to use "2016-Datacenter" Image , so I have added ImageName switch, which have details of 
 Image I have choose to Deploy. 
 ***Also this time I have selected AsJob switch, which immediately returns back the control. So you dont need to wait.
 
6. Get the sizes availabe in East US 

Get-AzVMSize -Location "EastUS" 


6. Once I have All set, I will use following command to create new VM
    type following command, hit enter
	
	New-AzVm `
    -ResourceGroupName "VmLabms" `
    -Name "myVMms" `
    -Location "EastUS" `
    -VirtualNetworkName "myVnetms" `
    -SubnetName "mySubnetms" `
    -SecurityGroupName "MyNSGms" `
    -PublicIpAddressName "myPublicIPms" `
    -ImageName "MicrosoftWindowsServer:WindowsServer:2016-Datacenter:latest" `
    -Credential $cred `
    -OpenPorts 80,3389 `
    -Size "Standard_DS3_V2" `
    -AsJob

It will print following on Powershell Command Prompt

Id     Name            PSJobTypeName   State         HasMoreData     Location             Command
--     ----            -------------   -----         -----------     --------             -------
1      Long Running... AzureLongRun... Running       True            localhost            New-AzVM

And return the control back to powershell prompt


PS C:\WINDOWS\system32> get-job

Id     Name            PSJobTypeName   State         HasMoreData     Location             Command
--     ----            -------------   -----         -----------     --------             -------
1      Long Running... AzureLongRun... Running       True            localhost            New-AzVM


PS C:\WINDOWS\system32> get-job

Id     Name            PSJobTypeName   State         HasMoreData     Location             Command
--     ----            -------------   -----         -----------     --------             -------
1      Long Running... AzureLongRun... Completed     True            localhost            New-AzVM

 
--Type the following command to get the list of Vm's

get-Azvm


will give following 

ResourceGroupName   Name Location          VmSize  OsType    NIC ProvisioningState Zone
-----------------   ---- --------          ------  ------    --- ----------------- ----
VMLABMS           myVMms   eastus Standard_DS3_v2 Windows myVMms         SucceededSucceeded


-- to connect to this vm we need IP address of same, for that run the following command

Get-AzPublicIpAddress -ResourceGroupName "VmLabms" | Select "IpAddress"

IpAddress
---------
52.152.137.135


to mstsc into vm, use the following command  "mstsc /v:publicIpAddress"

Type Following command and Hit Enter, it will prompt you to put credentials , use the credentials you have set initially
and login

	mstsc /v:52.152.137.135

On Login, to see your VM in action, install the IIS web server. Open a PowerShell prompt on the VM and run the following command and 
hit enter:	

Install-WindowsFeature -name Web-Server -IncludeManagementTools
	
--glimpse from inside vm command prompt
	
Windows PowerShell
Copyright (C) 2016 Microsoft Corporation. All rights reserved.

PS C:\Users\gpsadmin> Install-WindowsFeature -name Web-Server -IncludeManagementTools

Success Restart Needed Exit Code      Feature Result
------- -------------- ---------      --------------
True    No             Success        {Common HTTP Features, Default Document, D...	
	

--To see vm in action, type the IP address in web browser and hit enter
52.152.137.135 , It will open webpage with iis on that 

-- Once done with Practice, you can delete all by simply removing the resource group, all associated with resource group will be deleted.

Remove-AzResourceGroup -Name VMLABMS 

when prompted, type Y and hit enter.





~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~End Of File~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Let's Make World a better place to work !
