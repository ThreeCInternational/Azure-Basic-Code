--Changing the Powerstate of VM in Azure Tenant via PowerShell 

--Project Details
--Cloud Connect Consult (3C) Project
--Prepared by GS
--Email 			      : CloudConnectConsult@Outlook.com 
--Start Date		    : 11/12/2021 09:20 AM 	(MM/DD/YYYY HH:MM AM/PM)
--Date Completion	  : 11/13/2021 08:54 AM	(MM/DD/YYYY HH:MM AM/PM)


--There are 7 power states in which VM can existing
--Starting
--Running
--Stopping
--Stopped
--Deallocating
--Deallocated
-- Unknown "-"

--Type the following command to get the Powerstate

/> Get-AzVm -ResourceGroupName "VmLab13Nov" -VMName myVM13 -Status

PowerShell Output on running script

PS C:\WINDOWS\system32> Get-AzVm -ResourceGroupName "VmLab13Nov" -VMName myVM13 -Status


ResourceGroupName : VmLab13Nov
Name              : myVM13
ComputerName      : myVM13
OsName            : Windows Server 2016 Datacenter
OsVersion         : 10.0.14393.4770
HyperVGeneration  : V1
Disks[0]          :
  Name            : myVM13_OsDisk_1_6524be2d3da541e980ac2afef1ced947
  Statuses[0]     :
    Code          : ProvisioningState/succeeded
    Level         : Info
    DisplayStatus : Provisioning succeeded
    Time          : 13-11-2021 02:27:58
VMAgent           :
  VmAgentVersion  : 2.7.41491.1029
  Statuses[0]     :
    Code          : ProvisioningState/succeeded
    Level         : Info
    DisplayStatus : Ready
    Message       : GuestAgent is running and processing the extensions.
    Time          : 13-11-2021 02:29:46
Statuses[0]       :
  Code            : ProvisioningState/succeeded
  Level           : Info
  DisplayStatus   : Provisioning succeeded
  Time            : 13-11-2021 02:28:34
Statuses[1]       :
  Code            : PowerState/running
  Level           : Info
  DisplayStatus   : VM running


--We are going to disucss, four management commands here 
-Stop-AzVm
-StartAzVm
-Remove-AzVm
-Remove-AzResourceGroup

--Lets type the following command and Hit enter
-- Force switch is there, so that it will not ask for any confirmation, while shutting down
-- StayProvisioned switch is there, so that it allows VM to be stopped, without being Deallocated
--With StayProvision, you would continue to be charged for compute Cycles, however if you want to keep 
--Same Dynamic IP address, this is the way

C:/> Stop-AzVm -ResourceGroupName "VmLab13Nov" -Name "myVm13" -Force -StayProvisioned

PS C:\WINDOWS\system32> Stop-AzVm -ResourceGroupName "VmLab13Nov" -Name myVM13 -Force -StayProvisioned

OperationId : 2f647254-5ee9-45c6-befd-46cbeb955b4a
Status      : Succeeded
StartTime   : 13-11-2021 08:13:42
EndTime     : 13-11-2021 08:14:14
Error       :

PS C:\WINDOWS\system32>

--Check the status of the VM by Get-AzVM command

PS C:\WINDOWS\system32> Get-AzVm -ResourceGroupName "VmLab13Nov" -VMName myVM13 -Status


ResourceGroupName : VmLab13Nov
Name              : myVM13
ComputerName      : myVM13
OsName            : Windows Server 2016 Datacenter
OsVersion         : 10.0.14393.4770
HyperVGeneration  : V1
Disks[0]          :
  Name            : myVM13_OsDisk_1_6524be2d3da541e980ac2afef1ced947
  Statuses[0]     :
    Code          : ProvisioningState/succeeded
    Level         : Info
    DisplayStatus : Provisioning succeeded
    Time          : 13-11-2021 02:41:30
VMAgent           :
  VmAgentVersion  : 2.7.41491.1029
  Statuses[0]     :
    Code          : ProvisioningState/succeeded
    Level         : Info
    DisplayStatus : Ready
    Message       : GuestAgent is running and processing the extensions.
    Time          : 13-11-2021 02:43:29
Statuses[0]       :
  Code            : ProvisioningState/succeeded
  Level           : Info
  DisplayStatus   : Provisioning succeeded
  Time            : 13-11-2021 02:43:59
Statuses[1]       :
  Code            : PowerState/stopped
  Level           : Info
  DisplayStatus   : VM stopped

PS C:\WINDOWS\system32>

--you can see the status of VM is stopped, if you have not used -StayProvisioned switch, it would have been Deallocated



--Lets move to next command to start VM
Type the following script and Hit enter

Start-AzVm -ResourceGroupName "VmLab13Nov" -Name myVM13 

--PowerShell Output

PS C:\WINDOWS\system32> Start-AzVm -ResourceGroupName "VmLab13Nov" -Name myVM13

OperationId : 43e3c617-5716-4581-aa9c-9d05431e7674
Status      : Succeeded
StartTime   : 13-11-2021 08:23:32
EndTime     : 13-11-2021 08:24:07
Error       :

PS C:\WINDOWS\system32>

--Now check the status of VM again

PS C:\WINDOWS\system32> Get-AzVm -ResourceGroupName "VmLab13Nov" -VMName myVM13 -Status

ResourceGroupName : VmLab13Nov
Name              : myVM13
ComputerName      : myVM13
OsName            : Windows Server 2016 Datacenter
OsVersion         : 10.0.14393.4770
HyperVGeneration  : V1
Disks[0]          :
  Name            : myVM13_OsDisk_1_6524be2d3da541e980ac2afef1ced947
  Statuses[0]     :
    Code          : ProvisioningState/succeeded
    Level         : Info
    DisplayStatus : Provisioning succeeded
    Time          : 13-11-2021 02:41:30
VMAgent           :
  VmAgentVersion  : 2.7.41491.1029
  Statuses[0]     :
    Code          : ProvisioningState/succeeded
    Level         : Info
    DisplayStatus : Ready
    Message       : GuestAgent is running and processing the extensions.
    Time          : 13-11-2021 02:54:24
Statuses[0]       :
  Code            : ProvisioningState/succeeded
  Level           : Info
  DisplayStatus   : Provisioning succeeded
  Time            : 13-11-2021 02:53:41
Statuses[1]       :
  Code            : PowerState/running
  Level           : Info
  DisplayStatus   : VM running


PS C:\WINDOWS\system32>


--As we can see the status is coming as PowerState/Running



--Now as a next step, we will try to remove our virtual machine
--To do that we need to stop it first
--So its a two step process, first stop the vm than remove the VM

--type the following command, hit enter

Stop-AzVm -ResourceGroupName "VmLab13Nov" -Name myVM13 -Force 


--Powershell Output

PS C:\WINDOWS\system32> Stop-AzVm -ResourceGroupName "VmLab13Nov" -Name myVM13 -Force

OperationId : 3f43d826-13d6-4548-ba0e-33399bedf087
Status      : Succeeded
StartTime   : 13-11-2021 08:34:46
EndTime     : 13-11-2021 08:35:35
Error       :

PS C:\WINDOWS\system32>

--Now that it is stopped, lets remove the vm using following command

Remove-AzVm -ResourceGroupName "VmLab13Nov" -Name myVM13


PS C:\WINDOWS\system32> Remove-AzVm -ResourceGroupName "VmLab13Nov" -Name myVM13

Virtual machine removal operation
This cmdlet will remove the specified virtual machine. Do you want to continue?
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is "Y"): Y


OperationId : 0dcbee12-c17e-481c-8382-1baa780978a3
Status      : Succeeded
StartTime   : 13-11-2021 08:37:24
EndTime     : 13-11-2021 08:37:46
Error       :

PS C:\WINDOWS\system32>

--Please note, removing the vm will only remove the virtual machine, not the attached resources
--you need to remove all those resources manually


-- Once done with Practice, you can delete all by simply removing the resource group, all associated with resource group will be deleted.
--You can also use -Force switch
-- when prompted, type Y and hit enter.


PS C:\WINDOWS\system32> Remove-AzResourceGroup -Name VmLab13Nov

Confirm
Are you sure you want to remove resource group 'VmLab13Nov'
[Y] Yes  [N] No  [S] Suspend  [?] Help (default is "Y"): Y
True
PS C:\WINDOWS\system32>




~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~End Of File~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Let's Make World a better place to work !